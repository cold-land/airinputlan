# AirInputLan - 手机输入，电脑实时同步

[English Documentation](README_EN.md)

电脑端语音输入体验差，手机端却很成熟。AirInputLan 通过局域网将手机输入的文字实时同步到电脑，适用于中英文混输、AI 对话、会议记录等办公场景。

## 项目说明

本项目提供两种语言实现：

- **go-lang/** - Go 语言版本（主要版本，功能完整，推荐使用）
- **nim-lang/** - Nim 语言版本（作者个人学习项目，用于学习 Nim 语言和对比两种语言的开发体验）

> **推荐使用 go-lang 版本**，该版本功能完整，经过充分测试。
## 📋 目录

- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [使用方法](#使用方法)
- [常见问题](#常见问题)
- [注意事项](#注意事项)
- [已知问题](#已知问题)
- [网络配置](#网络配置)
- [故障排除](#故障排除)
- [编译说明](#编译说明)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [版本说明](#版本说明)

## ✨ 功能特性

- ✅ **跨平台支持** - Windows/macOS/Linux 全平台适配
- ✅ **智能网卡识别** - 自动识别 USB 共享网卡、本地连接、虚拟网卡
- ✅ **优先级排序** - 以太网 > USB共享网卡 > WiFi > 虚拟网卡
- ✅ **实时文字同步** - 通过 SSE 实现低延迟实时同步
- ✅ **双模式分段** - 支持单次输入模式和连续输入模式
  - **单次输入模式**：手机端检测 2 秒无输入后自动分段
  - **连续输入模式**：服务端检测 2 秒无输入后自动分段
- ✅ **手机端主题切换** - 支持亮色和暗色两种主题，自动保存用户偏好
- ✅ **便捷操作** - 单击复制、双击编辑
- ✅ **零依赖运行** - 单文件可执行程序，双击即用
- ✅ **全内存运行** - 程序关闭后数据自动清空，无本地残留，保护用户隐私
- ✅ **单实例保护** - 防止多实例运行，自动清理过期锁
- ✅ **端口自动适配** - 从 5000 端口开始自动尝试可用端口

## 🚀 快速开始

### 下载预编译版本

从 [Releases](../../releases) 页面下载对应平台的可执行文件：

| 平台 | 文件名 | 大小 |
|------|--------|------|
| Windows | `AirInputLan.exe` | ~1.9M |
| macOS | `AirInputLan` | ~1.9M |
| Linux | `AirInputLan` | ~1.9M |

下载后直接运行即可：
- **Windows**: 双击 `AirInputLan.exe`
- **macOS**: 运行 `./AirInputLan`
- **Linux**: 运行 `./AirInputLan`

程序会自动打开浏览器显示电脑端界面。

## 📖 使用方法

### 基本使用流程

1. **启动程序**
   - Windows: 双击 `AirInputLan.exe`
   - macOS/Linux: 运行 `./AirInputLan`
   - 程序会自动打开浏览器显示电脑端界面

2. **选择网卡（如果检测到多个）**
   - 如果检测到多个网卡，在电脑端界面选择要使用的网卡
   - 优先选择"以太网"类型的网卡
   - 如果有 USB 共享网络，选择 USB 网卡

3. **打开手机端输入界面**
   - 方式一：手机浏览器扫描电脑端显示的二维码
   - 方式二：在手机浏览器中输入显示的 IP 地址和端口（如 `http://192.168.1.10:5000`）

4. **开始输入**
   - 在手机端输入文字
   - 内容实时同步到电脑端底部
   - 停止输入 2 秒后自动生成历史卡片

5. **使用卡片**
   - 单击卡片：复制内容到剪贴板
   - 双击卡片：进入编辑模式
   - 编辑完成后，点击窗口空白区域：自动保存并复制到剪贴板
   - 编辑时点击其他卡片：自动保存当前编辑内容（不会复制，避免复制错误的卡片内容）

### 界面说明

#### 电脑端界面
- **显控区**：显示连接信息、IP 地址、端口、二维码
  - 当有手机连接时，自动隐藏二维码
  - 当手机断开时，自动恢复显示二维码
- **历史卡片区**：显示所有分段的历史记录卡片
- **正在输入区**：实时显示当前正在输入的内容

#### 手机端界面
- **全屏输入框**：支持多行输入
- **自动换行**：优化移动端输入体验
- **状态提示**：显示连接状态、输入状态
- **分段模式切换**：
  - **连续输入**（开关关闭）：服务端控制分段，适合长文本输入
  - **单次输入**（开关打开）：手机端控制分段，适合短句输入
  - 切换模式时会清空当前输入内容
- **主题切换**：
  - 支持亮色和暗色两种主题
  - 点击右上角 🌙/☀️ 按钮切换
  - 自动保存主题偏好到本地

## ❓ 常见问题

### Q1: 手机无法访问电脑端？

**可能原因：**
1. 防火墙阻止了 5000 端口
2. 杀毒软件拦截了连接
3. 手机和电脑不在同一网络
4. IP 地址不正确

**解决方法：**
1. 检查防火墙设置，允许 5000 端口
2. 在杀毒软件中添加程序白名单
3. 确认手机和电脑在同一局域网
4. 使用 USB 共享网络（推荐）

### Q2: 提示"程序已经在运行中"？

**可能原因：**
- 程序异常崩溃后锁文件未清理

**解决方法：**
- 程序会自动检测并清理过期锁文件
- 如果仍无法启动，手动删除锁文件：
  - Windows: `%TEMP%\airinputlan_main.lock`
  - Linux/macOS: `/tmp/airinputlan_main.lock`

### Q3: 扫描到多个网卡，应该选哪个？

**建议：**
1. 优先选择"以太网"类型的网卡
2. 如果有 USB 共享网络，选择 USB 网卡
3. 避免选择虚拟网卡（除非你在虚拟机中运行）

### Q4: 编辑后如何保存？

**操作方式：**
1. 点击其他卡片：自动保存当前编辑内容（不会复制，避免复制错误的卡片内容）
2. 点击窗口空白区域：自动保存当前编辑内容并复制到剪贴板
3. 保存后内容会自动复制到剪贴板（点击空白区域时）

### Q5: 支持多设备同时连接吗？

**设计初衷：**
- 不支持多设备同时连接
- 同一时间只允许一个手机端连接

**当前状态（已知 bug）：**
- 存在 bug，允许多个手机同时连接
- 后续版本将修复为只支持单设备连接

## ⚠️ 注意事项

- **仅支持局域网连接** - 不支持跨网段、外网连接
- **单设备连接限制** - 同一时间只允许一个手机端连接
- **数据安全** - 全内存运行，程序关闭后数据清空
- **防火墙** - 首次使用需开放防火墙端口
- **杀毒软件** - 某些杀毒软件可能需要添加白名单
- **浏览器兼容** - 手机端支持 Chrome、Edge、Safari、Firefox 主流浏览器
- **二维码生成** - 依赖网络，使用第三方网站 API 生成二维码，需要电脑能访问外网

- **仅支持局域网连接** - 不支持跨网段、外网连接
- **单设备连接限制** - 同一时间只允许一个手机端连接
- **数据安全** - 全内存运行，程序关闭后数据清空
- **防火墙** - 首次使用需开放防火墙端口
- **杀毒软件** - 某些杀毒软件可能需要添加白名单
- **浏览器兼容** - 手机端支持 Chrome、Edge、Safari、Firefox 主流浏览器
- **二维码生成** - 依赖网络，使用第三方网站 API 生成二维码，需要电脑能访问外网。如果电脑没有外网连接，可以手动在手机浏览器输入 IP 地址和端口（如 `http://192.168.1.10:5000`）
- **多设备连接 Bug** - 当前版本存在 bug，允许多个手机同时连接（设计应该只支持单设备连接），后续版本将修复
- **锁文件未清理** - 程序异常崩溃后，锁文件可能未清理，导致提示"程序已经在运行中"，程序会自动检测并清理过期锁文件

## 🔧 网络配置

### 网卡优先级

程序会自动扫描所有可用网卡，并按以下优先级排序：

1. **以太网**（本地连接）- 最可能正确
2. **USB共享网卡** - 次选
3. **WiFi** - 再次
4. **虚拟网卡**（VMware、VirtualBox、Hyper-V 等）- 最后，但仍然可用

### 虚拟网卡识别

程序会识别以下虚拟网卡类型：
- **容器网络**：virbr, veth, docker, br-, tun, tap, lxc, lxd, podman, flannel, cni
- **VMware**：vmnet, vmware
- **VirtualBox**：vbox, vnic
- **Hyper-V**：vEthernet
- **KVM/QEMU**：kvm, qemu

### 端口配置

- 默认起始端口：`5000`
- 最大尝试次数：`100`（5000-5099）
- 自动适配：如果端口被占用，自动尝试下一个端口

### 防火墙配置

如果手机无法访问，请检查防火墙设置：

#### Windows 防火墙
首次运行程序时，Windows 会弹出防火墙提示，点击"允许"即可让 AirInputLan 通过防火墙。

#### Linux 防火墙（firewalld）
用于 RedHat、Fedora、Rocky Linux、CentOS 等发行版：
```bash
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload
```

#### Linux 防火墙（ufw）
用于 Debian、Ubuntu、Linux Mint 等发行版：
```bash
sudo ufw allow 5000/tcp
```

#### macOS 防火墙
1. 打开"系统偏好设置" → "安全性与隐私" → "防火墙"
2. 点击"防火墙选项"
3. 添加 `AirInputLan` 并允许传入连接

## 🔍 故障排除

### 端口被占用

**症状：** 程序启动失败，提示端口被占用

**解决方法：**
1. 程序会自动尝试下一个端口（5001、5002...）
2. 手动释放占用 5000 端口的程序
3. 使用 `netstat -ano | findstr :5000`（Windows）查看占用进程

### 网络连接超时

**症状：** 手机访问地址超时

**解决方法：**
1. 检查手机和电脑是否在同一网络
2. 尝试使用 USB 共享网络
3. 检查防火墙和杀毒软件设置
4. 尝试更换端口

### 二维码无法扫描

**症状：** 手机无法扫描二维码

**解决方法：**
1. 手动输入显示的地址
2. 确认二维码清晰可见
3. 检查手机摄像头权限
4. 尝试使用其他扫码应用

### 剪贴板无法复制

**症状：** 单击卡片后无法粘贴

**解决方法：**
1. 确认浏览器剪贴板权限（部分浏览器需要用户授权）
2. 检查是否有其他程序占用剪贴板
3. 重新复制一次
4. 尝试使用其他浏览器

## 🔨 编译说明

### 统一编译脚本

使用统一编译脚本，自动检测当前平台并编译：

```bash
cd go-lang
./scripts/build_all.sh
```

编译产物位于 `dist/` 目录，文件名包含平台标识。

### 手动编译

#### Linux
```bash
cd go-lang
./scripts/build_linux.sh
chmod +x dist/AirInputLan-x86_64-linux
./dist/AirInputLan-x86_64-linux
```

#### Windows
```bash
cd go-lang
./scripts/build_windows.sh
dist\AirInputLan-x86_64-win.exe
```

#### macOS
```bash
cd go-lang
./scripts/build_macos.sh
./dist/AirInputLan-x86_64-macos
```

### 压缩编译产物

编译完成后，可以使用 UPX 压缩可执行文件：

```bash
cd go-lang
./scripts/compress.sh
```

压缩后文件大小约为原始大小的 31-32%。

### 编译要求

- Go 1.21 或更高版本
- UPX（可选，用于压缩可执行文件）

## 🛠 技术栈

- **语言**: Go 1.21+
- **网络协议**: HTTP + SSE (Server-Sent Events)
- **前端**: 原生 HTML/CSS/JavaScript
- **跨平台**: 静态编译（无外部依赖）

## 📁 项目结构

```
go-lang/
├── internal/           # 内部模块
│   ├── netif/         # 网卡扫描和识别
│   │   ├── scanner.go # 网卡扫描实现
│   │   └── types.go   # 类型定义
│   ├── network/       # 网络服务
│   │   ├── http.go    # HTTP 服务
│   │   ├── port.go    # 端口适配
│   │   ├── qrcode.go  # 二维码生成
│   │   └── sse.go     # SSE 服务
│   ├── state/         # 状态管理
│   │   └── content.go # 内容状态和自动分段
│   └── singleinstance/ # 单实例锁
│       ├── lock.go          # Unix 锁实现
│       ├── lock_common.go   # 通用锁
│       └── lock_windows.go  # Windows 锁
├── web/               # 前端资源
│   ├── pc/            # 电脑端界面
│   │   └── index.html
│   └── mobile/        # 手机端界面
│       └── index.html
├── scripts/           # 编译脚本
│   ├── build_all.sh   # 统一编译
│   ├── build_linux.sh # Linux 编译
│   ├── build_macos.sh # macOS 编译
│   ├── build_windows.sh # Windows 编译
│   └── compress.sh    # 压缩脚本
├── dist/              # 编译产物
├── main.go            # 主程序
├── go.mod             # Go 模块
└── README.md          # 本文件
```

## 📦 版本说明

### v1.1（当前版本）

**新增功能：**
- ✅ 双模式分段系统（单次输入/连续输入）
- ✅ 手机端主题切换（明亮/暗色）
- ✅ 手机端界面优化（竖向文字、连接状态指示器）

**修复问题：**
- 🐛 修复 PC 端刷新页面后二维码一直显示的问题
- 🐛 修复模式切换时双重分段的问题
- 🐛 修复手机重连后模式不一致的问题

### v1.0.34

**新增功能：**
- ✅ 网卡优先级优化（以太网 > USB共享网卡 > WiFi > 虚拟网卡）
- ✅ 增强虚拟网卡识别（VMware、VirtualBox、Hyper-V、KVM/QEMU 等）
- ✅ Windows 单实例锁修复（自动清理过期锁）

**修复问题：**
- 🐛 修复 Windows 崩溃后无法启动的问题

### v1.0.33

- 初始稳定版本
- 基础功能完整

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，请提交 Issue。

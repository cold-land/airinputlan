<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AirInputLan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        /* 显控区 */
        .control-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .qr-container {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        #qr-code {
            font-family: monospace;
            font-size: 10px;
            line-height: 1.2;
            text-align: center;
            color: #333;
        }

        #qr-code img {
            max-width: 200px;
            height: auto;
        }

        .ip-info {
            width: 100%;
            margin-bottom: 20px;
        }

        .ip-list {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .port-info {
            font-size: 14px;
            color: #666;
        }

        .tips {
            font-size: 12px;
            color: #999;
            text-align: center;
            line-height: 1.8;
        }

        /* 历史卡片区 */
        .history-cards {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
            position: relative;
        }

        .card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .card::after {
            content: "单击复制，双击编辑";
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 10px;
            color: #999;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .card:hover::after {
            opacity: 1;
        }

        .card.editing {
            outline: 2px solid #2196F3;
        }

        .card.copied {
            background: #E3F2FD;
        }

        .card textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 14px;
            line-height: 1.6;
            background: transparent;
        }

        /* 正在输入区 */
        .input-area {
            min-height: 60px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 10px;
        }

        .current-input {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* 隐藏滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 显控区 -->
        <div id="control-panel" class="control-panel">
            <div class="qr-container">
                <div id="qr-code">等待生成二维码...</div>
            </div>
            <div class="ip-info">
                <div class="ip-list" id="ip-list"></div>
                <div class="port-info" id="port-info"></div>
            </div>
            <div class="tips">
                <p>1. 请开放防火墙端口</p>
                <p>2. 扫码或输入 IP+端口连接</p>
            </div>
        </div>

        <!-- 历史卡片区 -->
        <div id="history-cards" class="history-cards"></div>

        <!-- 正在输入区 -->
        <div id="input-area" class="input-area">
            <div id="current-input" class="current-input"></div>
        </div>
    </div>

    <script>
        // 状态
        let isConnected = false;
        let eventSource = null;
        let reconnectInterval = null;
        let updateTimeout = null; // 防抖定时器

        // 初始化
        function init() {
            console.log('初始化...');

            // 清空所有内容
            document.getElementById('history-cards').innerHTML = '';
            document.getElementById('current-input').textContent = '';

            loadServerInfo();
            setupEventSource();
        }

        // 加载服务器信息
        async function loadServerInfo() {
            try {
                const [ipsRes, portRes] = await Promise.all([
                    fetch('/api/ip'),
                    fetch('/api/port')
                ]);

                const ipsData = await ipsRes.json();
                const portData = await portRes.json();

                console.log('========== 服务器信息 ==========');
                console.log('IP数据:', ipsData);
                console.log('IP数量:', ipsData.ips ? ipsData.ips.length : 0);
                console.log('端口数据:', portData);
                console.log('================================');

                displayIPs(ipsData.ips);
                displayPort(portData.port);
                generateQRCode(ipsData.ips, portData.port);
            } catch (error) {
                console.error('加载服务器信息失败:', error);
            }
        }

        // 显示 IP 列表
        function displayIPs(ips) {
            const container = document.getElementById('ip-list');
            if (ips && ips.length > 0) {
                if (ips.length === 1) {
                    // 只有一个IP，直接显示
                    container.innerHTML = `<strong>IP:</strong> ${ips[0].ip}`;
                } else {
                    // 有多个IP，显示所有IP供选择
                    let html = '<div style="margin-bottom: 10px;"><strong>检测到多个可用网络，请选择一个：</strong></div>';
                    html += '<select id="ip-select" style="width: 100%; padding: 8px; font-size: 14px;">';
                    
                    // 优先显示第一个IP（已按优先级排序：以太网 > USB共享网卡 > WiFi）
                    ips.forEach((ip, index) => {
                        const isSelected = index === 0 ? 'selected' : '';
                        const label = `${ip.ip} (${ip.nicType})`;
                        html += `<option value="${ip.ip}" ${isSelected}>${label}</option>`;
                    });
                    
                    html += '</select>';
                    container.innerHTML = html;
                    
                    // 监听IP选择变化
                    document.getElementById('ip-select').addEventListener('change', function() {
                        const selectedIP = this.value;
                        console.log('用户选择了IP:', selectedIP);
                        // 重新生成二维码
                        const port = document.getElementById('port-info').textContent.replace('端口: ', '');
                        generateQRCodeForIP(selectedIP, port);
                    });
                }
            }
        }

        // 显示端口
        function displayPort(port) {
            document.getElementById('port-info').innerHTML = `<strong>端口:</strong> ${port}`;
        }

        // 生成二维码
        function generateQRCode(ips, port) {
            if (ips && ips.length > 0) {
                // 使用第一个IP（已按优先级排序：以太网 > USB共享网卡 > WiFi）
                const selectedIP = ips[0];
                generateQRCodeForIP(selectedIP.ip, port);
            }
        }

        // 根据指定IP生成二维码
        function generateQRCodeForIP(ip, port) {
            const container = document.getElementById('qr-code');
            const url = `http://${ip}:${port}`;
            
            console.log('生成二维码，URL:', url);
            
            // 使用在线二维码 API 生成二维码
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            container.innerHTML = `<img src="${qrUrl}" alt="二维码">`;
        }

        

        // 设置 SSE 连接
        function setupEventSource() {
            if (eventSource) {
                eventSource.close();
            }

            console.log('建立 SSE 连接...');
            eventSource = new EventSource('/ws');

            eventSource.onopen = () => {
                console.log('SSE 连接已建立');
            };

            eventSource.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('收到 message 事件:', data);
                    handleMessage(data);
                } catch (error) {
                    console.error('解析消息失败:', error);
                }
            });

            eventSource.onerror = () => {
                console.log('连接断开');
                isConnected = false;
                // 断开后显示显控区
                showControlPanel();
                eventSource.close();

                // 5秒后重连
                if (reconnectInterval) clearInterval(reconnectInterval);
                reconnectInterval = setInterval(() => {
                    if (!isConnected) {
                        console.log('尝试重连...');
                        setupEventSource();
                    }
                }, 5000);
            };

            eventSource.addEventListener('connected', (event) => {
                const data = JSON.parse(event.data);
                console.log('收到 connected 事件:', data);
                isConnected = true;
            });

            eventSource.addEventListener('heartbeat', () => {
                // 心跳响应
            });
        }

        // 处理消息
        function handleMessage(message) {
            console.log('处理消息:', message);

            if (message.type === 'text') {
                // 收到文本消息：直接更新底部输入区
                console.log('收到文本消息:', message.data);
                updateCurrentInput(message.data);
            } else if (message.type === 'segment') {
                // 收到分段信号：把底部内容变成卡片，清空底部
                console.log('收到分段信号:', message.data);
                const currentContent = document.getElementById('current-input').textContent;
                if (currentContent) {
                    // 检查是否只包含空白字符
                    const hasNonSpace = currentContent.trim().length > 0;
                    if (hasNonSpace) {
                        addCard(currentContent);
                    }
                    updateCurrentInput('');
                }
            } else if (message.type === 'show_qr') {
                // 收到二维码显示/隐藏信号
                const showQR = message.data === 'true';
                console.log('收到二维码显示信号:', showQR);
                if (showQR) {
                    showControlPanel();
                } else {
                    hideControlPanel();
                }
            }
        }

        // 更新当前输入（带防抖）
        function updateCurrentInput(text) {
            console.log('更新输入区，内容长度:', text.length);
            
            // 清除之前的定时器
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // 防抖：50ms 后更新
            updateTimeout = setTimeout(() => {
                console.log('执行 DOM 更新');
                document.getElementById('current-input').textContent = text;
            }, 50); // 50ms 防抖
        }

        // 添加卡片
        function addCard(text) {
            console.log('添加卡片:', text);
            const container = document.getElementById('history-cards');
            const card = createCard(text);
            container.appendChild(card);

            // 限制卡片数量
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }

            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // 创建卡片
        function createCard(text) {
            const card = document.createElement('div');
            card.className = 'card';
            card.textContent = text;
            // 保存原始文本，用于编辑
            card.dataset.originalText = text;

            // 单击复制
            card.onclick = () => {
                const currentText = card.dataset.originalText || card.textContent;
                copyToClipboard(currentText);
                card.classList.add('copied');
                setTimeout(() => card.classList.remove('copied'), 500);
            };

            // 双击编辑
            card.ondblclick = () => {
                const currentText = card.dataset.originalText || card.textContent;
                enterEditMode(card, currentText);
            };

            return card;
        }

        // 进入编辑模式
        function enterEditMode(card, originalText) {
            card.classList.add('editing');
            const textarea = document.createElement('textarea');
            textarea.value = originalText;
            textarea.rows = 3; // 初始显示3行
            textarea.style.width = '100%';
            textarea.style.resize = 'vertical'; // 允许垂直调整大小
            textarea.style.fontSize = '14px';
            textarea.style.lineHeight = '1.6';
            textarea.style.border = 'none';
            textarea.style.outline = 'none';
            textarea.style.backgroundColor = 'transparent';
            card.textContent = '';
            card.appendChild(textarea);
            textarea.focus();

            const confirmEdit = () => {
                const newText = textarea.value.trim();
                if (newText && newText !== originalText) {
                    // 更新卡片内容
                    card.textContent = newText;
                    // 更新 data-original-text 属性
                    card.dataset.originalText = newText;
                    copyToClipboard(newText);
                } else {
                    card.textContent = originalText;
                }
                card.classList.remove('editing');
            };

            textarea.onblur = confirmEdit;
            textarea.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    card.textContent = originalText;
                    card.classList.remove('editing');
                }
            };
        }

        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).catch(err => {
                console.error('复制失败:', err);
            });
        }

        // 隐藏显控区
        function hideControlPanel() {
            console.log('隐藏显控区');
            document.getElementById('control-panel').classList.add('hidden');
        }

        // 显示显控区
        function showControlPanel() {
            console.log('显示显控区');
            document.getElementById('control-panel').classList.remove('hidden');
        }

        // 启动
        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AirInputLan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* æš—è‰²ä¸»é¢˜ */
        body.dark-theme {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            width: 90%;
            margin: 0 auto;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        body.dark-theme .theme-toggle {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        /* AIä¿®æ­£æŒ‰é’® */
        .ai-toggle {
            position: fixed;
            top: 50px;
            right: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .ai-toggle:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        body.dark-theme .ai-toggle {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        /* æ˜¾æ§åŒº */
        .control-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            transition: background 0.3s, box-shadow 0.3s;
        }

        body.dark-theme .control-panel {
            background: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .qr-container {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            transition: background 0.3s;
        }

        body.dark-theme .qr-container {
            background: #333;
        }

        #qr-code {
            font-family: monospace;
            font-size: 10px;
            line-height: 1.2;
            text-align: center;
            color: #333;
            transition: color 0.3s;
        }

        body.dark-theme #qr-code {
            color: #e0e0e0;
        }

        #qr-code img {
            max-width: 200px;
            height: auto;
        }

        .ip-info {
            width: 100%;
            margin-bottom: 20px;
        }

        .ip-list {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
            transition: color 0.3s;
        }

        body.dark-theme .ip-list {
            color: #e0e0e0;
        }

        .port-info {
            font-size: 14px;
            color: #666;
            transition: color 0.3s;
        }

        body.dark-theme .port-info {
            color: #aaa;
        }

        .tips {
            font-size: 12px;
            color: #999;
            text-align: center;
            line-height: 1.8;
            transition: color 0.3s;
        }

        body.dark-theme .tips {
            color: #888;
        }

        /* å†å²å¡ç‰‡åŒº */
        .history-cards {
            flex: 1;
            overflow-y: auto;
            padding: 4px 6px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: all 0.2s;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
            position: relative;
            color: #333;
        }

        body.dark-theme .card {
            background: #2a2a2a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
            color: #e0e0e0;
        }

        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        body.dark-theme .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 2px 4px rgba(0,0,0,0.3);
        }

        .card::after {
            content: "å•å‡»å¤åˆ¶ï¼ŒåŒå‡»ç¼–è¾‘";
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 10px;
            color: #999;
            opacity: 0;
            transition: opacity 0.2s;
        }

        body.dark-theme .card::after {
            color: #888;
        }

        .card:hover::after {
            opacity: 1;
        }

        .card.editing {
            outline: none;
            box-shadow: 0 0 0 2px #2196F3, 0 4px 8px rgba(0,0,0,0.12);
            position: relative;
            z-index: 1;
        }

        body.dark-theme .card.editing {
            box-shadow: 0 0 0 2px #2196F3, 0 4px 8px rgba(0,0,0,0.4);
        }

        .card.copied {
            background: #E3F2FD;
        }

        body.dark-theme .card.copied {
            background: #1565C0;
        }

        .card textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            resize: none;
            font-size: 14px;
            line-height: 1.6;
            background: transparent;
            color: inherit;
        }

        /* é‡å¤å­—é«˜äº®æ ·å¼ */
        .highlight {
            background-color: #FFF9C4;
            padding: 0 2px;
            border-radius: 2px;
        }

        body.dark-theme .highlight {
            background-color: #FF6F00;
            color: white;
        }

        /* æ­£åœ¨è¾“å…¥åŒº */
        .input-area {
            min-height: 60px;
            padding: 10px 22px;
            background: #E8F5E9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
            transition: background 0.3s, box-shadow 0.3s;
        }

        body.dark-theme .input-area {
            background: #263238;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border: 1px solid #37474F;
        }

        .current-input {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            transition: color 0.3s;
        }

        body.dark-theme .current-input {
            color: #e0e0e0;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .hidden {
            display: none !important;
        }

        /* IP é€‰æ‹©ä¸‹æ‹‰æ¡† */
        #ip-select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #333;
            transition: background 0.3s, border-color 0.3s, color 0.3s;
        }

        body.dark-theme #ip-select {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        /* AIè®¾ç½®æ¨¡æ€æ¡† */
        .ai-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .ai-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: background 0.3s;
        }

        body.dark-theme .ai-modal-content {
            background: #2a2a2a;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .ai-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            transition: border-color 0.3s;
        }

        body.dark-theme .ai-modal-header {
            border-bottom-color: #444;
        }

        .ai-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
            transition: color 0.3s;
        }

        body.dark-theme .ai-modal-header h2 {
            color: #e0e0e0;
        }

        .ai-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .ai-modal-close:hover {
            color: #333;
        }

        body.dark-theme .ai-modal-close:hover {
            color: #e0e0e0;
        }

        .ai-modal-body {
            padding: 20px;
        }

        .ai-config-item {
            margin-bottom: 20px;
        }

        .ai-config-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            transition: color 0.3s;
        }

        body.dark-theme .ai-config-item label {
            color: #e0e0e0;
        }

        .ai-config-item input[type="text"],
        .ai-config-item textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            color: #333;
            transition: background 0.3s, border-color 0.3s, color 0.3s;
        }

        body.dark-theme .ai-config-item input[type="text"],
        body.dark-theme .ai-config-item textarea {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        .ai-config-item textarea {
            resize: vertical;
        }

        .ai-config-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .ai-config-actions button {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: background 0.3s, border-color 0.3s, color 0.3s;
        }

        .ai-config-actions button:hover {
            background: #f5f5f5;
        }

        body.dark-theme .ai-config-actions button {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-theme .ai-config-actions button:hover {
            background: #444;
        }

        .ai-config-warning {
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            transition: background 0.3s, border-color 0.3s;
        }

        body.dark-theme .ai-config-warning {
            background: #523e02;
            border-color: #856404;
        }

        .ai-config-warning p {
            margin: 5px 0;
            font-size: 13px;
            line-height: 1.6;
            color: #856404;
            transition: color 0.3s;
        }

        body.dark-theme .ai-config-warning p {
            color: #ffecb5;
        }

        .ai-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #ddd;
            transition: border-color 0.3s;
        }

        body.dark-theme .ai-modal-footer {
            border-top-color: #444;
        }

        .ai-modal-cancel,
        .ai-modal-save {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .ai-modal-cancel {
            background: #f5f5f5;
            color: #333;
        }

        .ai-modal-cancel:hover {
            background: #e0e0e0;
        }

        .ai-modal-save {
            background: #2196F3;
            color: white;
        }

        .ai-modal-save:hover {
            background: #1976D2;
        }

        body.dark-theme .ai-modal-cancel {
            background: #444;
            color: #e0e0e0;
        }

        body.dark-theme .ai-modal-cancel:hover {
                    background: #555;
                }
        
                /* AIä¿®æ­£æŒ‰é’® */
                .ai-correct-button {
                    flex-shrink: 0;
                    width: 32px;
                    height: 32px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    background: white;
                    cursor: pointer;
                    font-size: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s;
                }
        
                .ai-correct-button:hover {
                    background: #f5f5f5;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }
        
                .ai-correct-button:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
        
                body.dark-theme .ai-correct-button {
                    background: #333;
                    border-color: #555;
                }
        
                body.dark-theme .ai-correct-button:hover {
                    background: #444;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                }
            </style></head><body>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ åˆ‡æ¢ä¸»é¢˜</button>

    <!-- AIä¿®æ­£æŒ‰é’® -->
    <button id="ai-correction-toggle" class="ai-toggle" onclick="openAISettingsModal()">ğŸ¤– AIä¿®æ­£</button>

    <div id="app">
        <!-- æ˜¾æ§åŒº -->
        <div id="control-panel" class="control-panel">
            <div class="qr-container">
                <div id="qr-code">ç­‰å¾…ç”ŸæˆäºŒç»´ç ...</div>
            </div>
            <div class="ip-info">
                <div class="ip-list" id="ip-list"></div>
                <div class="port-info" id="port-info"></div>
            </div>
            <div class="tips">
                <p>1. è¯·å¼€æ”¾é˜²ç«å¢™ç«¯å£</p>
                <p>2. æ‰«ç æˆ–è¾“å…¥ IP+ç«¯å£è¿æ¥</p>
            </div>
        </div>

        <!-- å†å²å¡ç‰‡åŒº -->
        <div id="history-cards" class="history-cards"></div>

        <!-- æ­£åœ¨è¾“å…¥åŒº -->
        <div id="input-area" class="input-area">
            <div id="current-input" class="current-input"></div>
        </div>
    </div>

    <!-- AIè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="ai-settings-modal" class="ai-modal hidden">
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h2>AI è®¾ç½®</h2>
                <button class="ai-modal-close" onclick="closeAISettingsModal()">Ã—</button>
            </div>
            <div class="ai-modal-body">
                <div class="ai-config-item">
                    <label>
                        <input type="checkbox" id="ai-enabled">
                        å¯ç”¨AIä¿®æ­£
                    </label>
                </div>
                <div class="ai-config-item">
                    <label for="ai-api-url">Ollama APIåœ°å€ï¼š</label>
                    <input type="text" id="ai-api-url" placeholder="http://localhost:11434/api/generate">
                </div>
                <div class="ai-config-item">
                    <label for="ai-model">æ¨¡å‹åç§°ï¼š</label>
                    <input type="text" id="ai-model" placeholder="qwen3:0.6b">
                </div>
                <div class="ai-config-item">
                    <label for="ai-prompt">æç¤ºè¯æ¨¡æ¿ï¼š</label>
                    <textarea id="ai-prompt" rows="8" placeholder="è¯·è¾“å…¥æç¤ºè¯æ¨¡æ¿..."></textarea>
                </div>
                <div class="ai-config-actions">
                    <button onclick="exportAIConfig()">å¯¼å‡ºé…ç½®</button>
                    <button onclick="importAIConfig()">å¯¼å…¥é…ç½®</button>
                </div>
                <div class="ai-config-warning">
                    <p><strong>âš ï¸ é‡è¦è¯´æ˜ï¼š</strong></p>
                    <p>1. æ­¤åŠŸèƒ½ä¾èµ– Ollama æœåŠ¡</p>
                    <p>   è¯·ç¡®ä¿ Ollama å·²å¯åŠ¨å¹¶è¿è¡Œåœ¨ http://localhost:11434</p>
                    <p>2. é…ç½®ä»…åœ¨å½“å‰é¡µé¢æœ‰æ•ˆ</p>
                    <p>   åˆ·æ–°ç½‘é¡µåé…ç½®å°†ä¸¢å¤±</p>
                    <p>   è¯·åŠ¡å¿…ç‚¹å‡»"å¯¼å‡ºé…ç½®"ä¿å­˜é…ç½®æ–‡ä»¶</p>
                </div>
            </div>
            <div class="ai-modal-footer">
                <button class="ai-modal-cancel" onclick="closeAISettingsModal()">å–æ¶ˆ</button>
                <button class="ai-modal-save" onclick="saveAIConfig()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script src="/pc/js/qrcode.min.js"></script>
    <script>
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
        });

        // çŠ¶æ€
        let isConnected = false;
        let eventSource = null;
        let reconnectInterval = null;
        let updateTimeout = null; // é˜²æŠ–å®šæ—¶å™¨

        // AIé…ç½®ï¼ˆå…¨å†…å­˜è¿è¡Œï¼‰
        const DEFAULT_AI_CONFIG = {
            aiCorrectionEnabled: false,
            ollamaApiUrl: 'http://localhost:11434/api/generate',
            ollamaModel: 'qwen3:0.6b',
            aiPromptTemplate: 'ä½ æ˜¯ä¸“ä¸šçš„è¯­éŸ³è¯†åˆ«æ–‡æœ¬ä¿®æ­£åŠ©æ‰‹ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯å…ˆç†è§£æ•´å¥è¯çš„è¯­ä¹‰å’Œä½¿ç”¨åœºæ™¯ï¼Œå†é’ˆå¯¹æ€§ä¿®æ­£è¯­éŸ³è½¬æ–‡å­—çš„é”™è¯¯ï¼Œä»…è¾“å‡ºä¿®æ­£åçš„çº¯æ–‡æœ¬ï¼Œä¸è¦ä»»ä½•é¢å¤–è§£é‡Šã€æ ‡ç‚¹æˆ–å¤‡æ³¨ã€‚\nä¸¥æ ¼éµå¾ªä»¥ä¸‹é€šç”¨ä¿®æ­£è§„åˆ™ï¼š\n1. è¯­ä¹‰ä¼˜å…ˆï¼šåŸºäºæ•´å¥è¯çš„è¯­å¢ƒå’Œè¯­ä¹‰ï¼Œåˆ¤æ–­å¹¶ä¿®æ­£è¯­éŸ³è¯¯å¬çš„åŒéŸ³å­—ã€é”™å­—ã€æ¼å­—ã€å¤šå­—ï¼Œå°¤å…¶æ˜¯æŠ€æœ¯åœºæ™¯çš„è¯æ±‡ï¼ˆå¦‚è‹±æ–‡/æ•°å­—ç»„åˆã€ä¸“ä¸šæœ¯è¯­ï¼‰ï¼›\n2. ä¿ç•™æ ¸å¿ƒï¼šå®Œå…¨ä¿ç•™åŸå¥çš„æ•°å­—ã€è‹±æ–‡è¯æ±‡ã€ä¸“æœ‰åè¯ã€æ ¸å¿ƒè¯­ä¹‰å’ŒåŸºæœ¬å¥å¼ï¼Œä»…ä¿®æ­£é”™è¯¯ï¼Œä¸å¢åˆ ã€ä¸æ”¹å†™åŸæ„ï¼›\n3. æ¸…ç†å£è¯­ï¼šç§»é™¤æ— æ„ä¹‰çš„è¯­æ°”è¯ï¼ˆå—¯ã€å•Šã€å‘¢ã€å§ã€å“¦ã€å‘ƒã€ç„¶åï¼‰ã€é‡å¤è¯æ±‡ï¼ˆå¦‚æˆ‘ä»¬æˆ‘ä»¬ã€çš„çš„ï¼‰ã€å¤šä½™çš„æ— æ„ä¹‰å•å­—ï¼›\n4. è§„èŒƒæ ¼å¼ï¼šä¿®æ­£è‹±æ–‡/æŠ€æœ¯è¯æ±‡é—´çš„æ ‡ç‚¹é”™è¯¯ï¼ˆå¦‚é€—å·æ¢ç©ºæ ¼ï¼‰ã€é‡å¤æ ‡ç‚¹ï¼Œä¿æŒåŸå¥æ•´ä½“æ ‡ç‚¹å’Œå¥å¼ç»“æ„åŸºæœ¬ä¸å˜ï¼›\n5. æ‹¼å†™ä¿®æ­£ï¼šåŸºäºè¯­ä¹‰ä¿®æ­£æŠ€æœ¯è¯æ±‡çš„å­—æ¯é‡å¤ã€æ¼å†™ã€é”™å†™é—®é¢˜ï¼Œè¿˜åŸæ­£ç¡®çš„è‹±æ–‡ä¸“ä¸šè¯æ±‡ã€‚'
        };

        let aiConfig = { ...DEFAULT_AI_CONFIG };

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            const button = document.querySelector('.theme-toggle');
            button.textContent = isDark ? 'â˜€ï¸ åˆ‡æ¢ä¸»é¢˜' : 'ğŸŒ™ åˆ‡æ¢ä¸»é¢˜';
        }

        // å¯¼å‡ºAIé…ç½®
        function exportAIConfig() {
            const configJson = JSON.stringify(aiConfig, null, 2);
            const blob = new Blob([configJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'airinputlan-ai-config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥AIé…ç½®
        function importAIConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const config = JSON.parse(event.target.result);
                        // éªŒè¯é…ç½®é¡¹
                        if (typeof config.aiCorrectionEnabled === 'boolean' &&
                                    typeof config.ollamaApiUrl === 'string' &&
                                    typeof config.ollamaModel === 'string' &&
                                    typeof config.aiPromptTemplate === 'string') {
                                    aiConfig = config;
                                    updateAICorrectionButton();
                                } else {                            alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼');
                        }
                    } catch (error) {
                        alert('é…ç½®æ–‡ä»¶è§£æå¤±è´¥ï¼');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ä¿å­˜AIé…ç½®ï¼ˆä»é…ç½®ç•Œé¢ï¼‰
        function saveAIConfig() {
            const enabled = document.getElementById('ai-enabled').checked;
            const apiUrl = document.getElementById('ai-api-url').value.trim();
            const model = document.getElementById('ai-model').value.trim();
            const prompt = document.getElementById('ai-prompt').value.trim();

            if (!apiUrl || !model || !prompt) {
                alert('è¯·å¡«å†™æ‰€æœ‰é…ç½®é¡¹ï¼');
                return;
            }

            aiConfig = {
                aiCorrectionEnabled: enabled,
                ollamaApiUrl: apiUrl,
                ollamaModel: model,
                aiPromptTemplate: prompt
            };

            updateAICorrectionButton();
            closeAISettingsModal();
        }

        // æ›´æ–°AIä¿®æ­£æŒ‰é’®çŠ¶æ€
        function updateAICorrectionButton() {
            const button = document.getElementById('ai-correction-toggle');
            if (button) {
                button.textContent = aiConfig.aiCorrectionEnabled ? 'ğŸ¤– AIä¿®æ­£ï¼ˆå·²å¯ç”¨ï¼‰' : 'ğŸ¤– AIä¿®æ­£';
            }
        }

        // æ‰“å¼€AIè®¾ç½®æ¨¡æ€æ¡†
        function openAISettingsModal() {
            const modal = document.getElementById('ai-settings-modal');
            if (!modal) return;

            // å¡«å……å½“å‰é…ç½®
            document.getElementById('ai-enabled').checked = aiConfig.aiCorrectionEnabled;
            document.getElementById('ai-api-url').value = aiConfig.ollamaApiUrl;
            document.getElementById('ai-model').value = aiConfig.ollamaModel;
            document.getElementById('ai-prompt').value = aiConfig.aiPromptTemplate;

            modal.classList.remove('hidden');
        }

        // å…³é—­AIè®¾ç½®æ¨¡æ€æ¡†
        function closeAISettingsModal() {
            const modal = document.getElementById('ai-settings-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // HTML è½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢ XSS æ”»å‡»
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ£€æµ‹é‡å¤å­—å¹¶é«˜äº®
        // æ³¨æ„ï¼šæ­¤å‡½æ•°ä½¿ç”¨ innerHTML æ’å…¥å†…å®¹ï¼Œä½†æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½å·²é€šè¿‡ escapeHtml() è½¬ä¹‰
        function highlightDuplicates(text) {
            if (!text) return text;
        
            // å…ˆè½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
            const escapedText = escapeHtml(text);
            
            let result = '';
            let i = 0;
        
            while (i < escapedText.length) {
                // æ£€æµ‹åŒå­—é‡å¤
                if (i + 3 < escapedText.length) {
                    const twoChars = escapedText.substring(i, i + 2);
                    const nextTwoChars = escapedText.substring(i + 2, i + 4);
                    if (twoChars === nextTwoChars) {
                        result += `<span class="highlight">${twoChars}${twoChars}</span>`;
                        i += 4;
                        continue;
                    }
                }
        
                // æ£€æµ‹å•å­—é‡å¤
                if (i + 1 < escapedText.length) {
                    const char = escapedText[i];
                    const nextChar = escapedText[i + 1];
                    if (char === nextChar) {
                        result += `<span class="highlight">${char}${char}</span>`;
                        i += 2;
                        continue;
                    }
                }
        
                result += escapedText[i];
                i++;
            }
        
            return result;
        }
        // åˆå§‹åŒ–
        function init() {
            console.log('åˆå§‹åŒ–...');

            // æ¸…ç©ºæ‰€æœ‰å†…å®¹
            document.getElementById('history-cards').innerHTML = '';
            document.getElementById('current-input').textContent = '';

            loadServerInfo();
            setupEventSource();
        }

        // åŠ è½½æœåŠ¡å™¨ä¿¡æ¯
async function loadServerInfo() {
            const ipList = document.getElementById('ip-list');
            const portInfo = document.getElementById('port-info');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            ipList.innerHTML = 'åŠ è½½ä¸­...';
            portInfo.innerHTML = 'åŠ è½½ä¸­...';

            try {
                const [ipsRes, portRes] = await Promise.all([
                    fetch('/api/ip'),
                    fetch('/api/port')
                ]);

                const ipsData = await ipsRes.json();
                const portData = await portRes.json();

                console.log('========== æœåŠ¡å™¨ä¿¡æ¯ ==========');
                console.log('IPæ•°æ®:', ipsData);
                console.log('IPæ•°é‡:', ipsData.ips ? ipsData.ips.length : 0);
                console.log('ç«¯å£æ•°æ®:', portData);
                console.log('================================');

                displayIPs(ipsData.ips);
                displayPort(portData.port);
                generateQRCode(ipsData.ips, portData.port);
            } catch (error) {
                ipList.innerHTML = 'åŠ è½½å¤±è´¥';
                portInfo.innerHTML = 'åŠ è½½å¤±è´¥';
                console.error('åŠ è½½æœåŠ¡å™¨ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤º IP åˆ—è¡¨
        function displayIPs(ips) {
            const container = document.getElementById('ip-list');
            if (ips && ips.length > 0) {
                if (ips.length === 1) {
                    // åªæœ‰ä¸€ä¸ªIPï¼Œç›´æ¥æ˜¾ç¤º
                    container.innerHTML = '';
                    const strong = document.createElement('strong');
                    strong.textContent = 'IP: ';
                    container.appendChild(strong);
                    const text = document.createTextNode(ips[0].ip);
                    container.appendChild(text);
                } else {
                    // æœ‰å¤šä¸ªIPï¼Œæ˜¾ç¤ºæ‰€æœ‰IPä¾›é€‰æ‹©
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    const strong = document.createElement('strong');
                    strong.textContent = 'æ£€æµ‹åˆ°å¤šä¸ªå¯ç”¨ç½‘ç»œï¼Œè¯·é€‰æ‹©ä¸€ä¸ªï¼š';
                    div.appendChild(strong);
                    container.appendChild(div);
                    
                    const select = document.createElement('select');
                    select.id = 'ip-select';
                    select.style.width = '100%';
                    select.style.padding = '8px';
                    select.style.fontSize = '14px';
                    
                    // ä¼˜å…ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªIPï¼ˆå·²æŒ‰ä¼˜å…ˆçº§æ’åºï¼šä»¥å¤ªç½‘ > USBå…±äº«ç½‘å¡ > WiFiï¼‰
                    ips.forEach((ip, index) => {
                        const option = document.createElement('option');
                        option.value = ip.ip;
                        option.selected = index === 0;
                        const label = document.createTextNode(`${ip.ip} (${ip.nicType})`);
                        option.appendChild(label);
                        select.appendChild(option);
                    });
                    
                    container.appendChild(select);
                    
                    // ç›‘å¬IPé€‰æ‹©å˜åŒ–
                    document.getElementById('ip-select').addEventListener('change', function() {
                        const selectedIP = this.value;
                        console.log('ç”¨æˆ·é€‰æ‹©äº†IP:', selectedIP);
                        // é‡æ–°ç”ŸæˆäºŒç»´ç 
                        const port = document.getElementById('port-info').textContent.replace('ç«¯å£: ', '');
                        generateQRCodeForIP(selectedIP, port);
                    });
                }
            }
        }

        // æ˜¾ç¤ºç«¯å£
        function displayPort(port) {
            const portInfo = document.getElementById('port-info');
            portInfo.innerHTML = '';
            const strong = document.createElement('strong');
            strong.textContent = 'ç«¯å£: ';
            portInfo.appendChild(strong);
            const text = document.createTextNode(port);
            portInfo.appendChild(text);
        }

        // ç”ŸæˆäºŒç»´ç 
        function generateQRCode(ips, port) {
            if (ips && ips.length > 0) {
                // ä½¿ç”¨ç¬¬ä¸€ä¸ªIPï¼ˆå·²æŒ‰ä¼˜å…ˆçº§æ’åºï¼šä»¥å¤ªç½‘ > USBå…±äº«ç½‘å¡ > WiFiï¼‰
                const selectedIP = ips[0];
                generateQRCodeForIP(selectedIP.ip, port);
            }
        }

        // æ ¹æ®æŒ‡å®šIPç”ŸæˆäºŒç»´ç 
        function generateQRCodeForIP(ip, port) {
            const container = document.getElementById('qr-code');
            const url = `http://${ip}:${port}`;

            console.log('ç”ŸæˆäºŒç»´ç ï¼ŒURL:', url);

            // ä½¿ç”¨ QRCode.js åœ¨æœ¬åœ°ç”ŸæˆäºŒç»´ç 
            container.innerHTML = '';  // æ¸…ç©ºå®¹å™¨
            new QRCode(container, {
                text: url,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // è®¾ç½® SSE è¿æ¥
        function setupEventSource() {
            // å…ˆæ¸…é™¤æ—§çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢ç´¯ç§¯
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }

            // å…³é—­æ—§çš„ SSE è¿æ¥
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }

            console.log('å»ºç«‹ SSE è¿æ¥...');
            eventSource = new EventSource('/ws');

            eventSource.onopen = () => {
                console.log('SSE è¿æ¥å·²å»ºç«‹');
            };

            eventSource.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('æ”¶åˆ° message äº‹ä»¶:', data);
                    handleMessage(data);
                } catch (error) {
                    console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
                }
            });

            eventSource.onerror = () => {
                console.log('è¿æ¥æ–­å¼€');
                isConnected = false;
                // æ–­å¼€åæ˜¾ç¤ºæ˜¾æ§åŒº
                showControlPanel();
                eventSource.close();

                // 5ç§’åé‡è¿
                if (reconnectInterval) clearInterval(reconnectInterval);
                reconnectInterval = setInterval(() => {
                    if (!isConnected) {
                        console.log('å°è¯•é‡è¿...');
                        setupEventSource();
                    }
                }, 5000);
            };

            eventSource.addEventListener('connected', (event) => {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ° connected äº‹ä»¶:', data);
                isConnected = true;
            });

            eventSource.addEventListener('heartbeat', () => {
                // å¿ƒè·³å“åº”
            });
        }

        // å¤„ç†æ¶ˆæ¯
        function handleMessage(message) {
            console.log('å¤„ç†æ¶ˆæ¯:', message);

            if (message.type === 'text') {
                // æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯ï¼šç›´æ¥æ›´æ–°åº•éƒ¨è¾“å…¥åŒº
                console.log('æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯:', message.data);
                updateCurrentInput(message.data);
            } else if (message.type === 'segment') {
                // æ”¶åˆ°åˆ†æ®µä¿¡å·ï¼ˆæ—§é€»è¾‘ï¼‰ï¼šæŠŠåº•éƒ¨å†…å®¹å˜æˆå¡ç‰‡ï¼Œæ¸…ç©ºåº•éƒ¨
                console.log('æ”¶åˆ°åˆ†æ®µä¿¡å·ï¼ˆæ—§é€»è¾‘ï¼‰:', message.data);
                const currentContent = document.getElementById('current-input').textContent;
                if (currentContent) {
                    // æ£€æŸ¥æ˜¯å¦åªåŒ…å«ç©ºç™½å­—ç¬¦
                    const hasNonSpace = currentContent.trim().length > 0;
                    if (hasNonSpace) {
                        addCard(currentContent);
                    }
                    updateCurrentInput('');
                }
            } else if (message.type === 'card') {
                // æ”¶åˆ°å¡ç‰‡æ¶ˆæ¯ï¼ˆæ–°é€»è¾‘ï¼‰ï¼šç›´æ¥ç”Ÿæˆå¡ç‰‡ï¼ˆä½¿ç”¨æœåŠ¡ç«¯å‘é€çš„å†…å®¹ï¼‰
                console.log('æ”¶åˆ°å¡ç‰‡æ¶ˆæ¯ï¼ˆæ–°é€»è¾‘ï¼‰:', message.data);
                addCard(message.data);
            } else if (message.type === 'clear_input') {
                // æ”¶åˆ°æ¸…ç©ºè¾“å…¥æ¡†ä¿¡å·ï¼ˆæ–°é€»è¾‘ï¼‰ï¼šæ¸…ç©ºåº•éƒ¨è¾“å…¥åŒº
                console.log('æ”¶åˆ°æ¸…ç©ºè¾“å…¥æ¡†ä¿¡å·');
                updateCurrentInput('');
            } else if (message.type === 'show_qr') {
                // æ”¶åˆ°äºŒç»´ç æ˜¾ç¤º/éšè—ä¿¡å·
                const showQR = message.data === 'true';
                console.log('æ”¶åˆ°äºŒç»´ç æ˜¾ç¤ºä¿¡å·:', showQR);
                if (showQR) {
                    showControlPanel();
                } else {
                    hideControlPanel();
                }
            } else if (message.type === 'connected') {
                // æ”¶åˆ°è¿æ¥æˆåŠŸæ¶ˆæ¯
                console.log('æ”¶åˆ°è¿æ¥æˆåŠŸæ¶ˆæ¯');
                hideControlPanel();
            }
        }

        // æ›´æ–°å½“å‰è¾“å…¥ï¼ˆå¸¦é˜²æŠ–ï¼‰
        function updateCurrentInput(text) {
            console.log('æ›´æ–°è¾“å…¥åŒºï¼Œå†…å®¹é•¿åº¦:', text.length);
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // é˜²æŠ–ï¼š50ms åæ›´æ–°
            updateTimeout = setTimeout(() => {
                console.log('æ‰§è¡Œ DOM æ›´æ–°');
                document.getElementById('current-input').textContent = text;
            }, 50); // 50ms é˜²æŠ–
        }

        // æ·»åŠ å¡ç‰‡
        function addCard(text) {
            console.log('æ·»åŠ å¡ç‰‡:', text);
            const container = document.getElementById('history-cards');
            const card = createCard(text);
            container.appendChild(card);

            // é™åˆ¶å¡ç‰‡æ•°é‡
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        // åˆ›å»ºå¡ç‰‡
        function createCard(text) {
            // åˆ›å»ºå¡ç‰‡åŒ…è£…å™¨
            const cardWrapper = document.createElement('div');
            cardWrapper.style.display = 'flex';
            cardWrapper.style.alignItems = 'center';
            cardWrapper.style.gap = '10px';
            cardWrapper.style.marginBottom = '16px';

            // AIä¿®æ­£æŒ‰é’®ï¼ˆä»…åœ¨å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰- æ”¾åœ¨å¡ç‰‡å¤–é¢
            const aiButton = document.createElement('button');
            aiButton.className = 'ai-correct-button';
            aiButton.textContent = 'ğŸ¤–';
            aiButton.title = 'AIä¿®æ­£';
            aiButton.style.display = aiConfig.aiCorrectionEnabled ? 'block' : 'none';
            aiButton.onclick = (e) => {
                e.stopPropagation();
                correctCardWithAI(cardWrapper);
            };

            // åˆ›å»ºå¡ç‰‡
            const card = document.createElement('div');
            card.className = 'card';
            card.style.flex = '1';
            card.style.marginBottom = '0';

            // å¡ç‰‡å†…å®¹
            const cardContent = document.createElement('div');
            cardContent.className = "card-content";
            cardContent.innerHTML = highlightDuplicates(text);

            card.appendChild(cardContent);

            // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œç”¨äºç¼–è¾‘
            card.dataset.originalText = text;

            // å•å‡»å¤åˆ¶
            card.onclick = () => {
                const currentText = card.dataset.originalText || card.textContent;
                copyToClipboard(currentText);
                card.classList.add('copied');
                setTimeout(() => card.classList.remove('copied'), 500);
            };

            // åŒå‡»ç¼–è¾‘
            card.ondblclick = () => {
                const currentText = card.dataset.originalText || card.textContent;
                enterEditMode(card, currentText);
            };

            // å°†AIæŒ‰é’®å’Œå¡ç‰‡æ·»åŠ åˆ°åŒ…è£…å™¨
            cardWrapper.appendChild(aiButton);
            cardWrapper.appendChild(card);

            return cardWrapper;
        }

        // AIä¿®æ­£å¡ç‰‡
        async function correctCardWithAI(cardWrapper) {
            const card = cardWrapper.querySelector('.card');
            const originalText = card.dataset.originalText;
            if (!originalText) {
                alert('æ²¡æœ‰å¯ä¿®æ­£çš„æ–‡æœ¬ï¼');
                return;
            }

            const aiButton = cardWrapper.querySelector('.ai-correct-button');
            const cardContent = card.querySelector('.card-content');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            aiButton.textContent = 'â³';
            aiButton.disabled = true;
            const originalContent = cardContent.innerHTML;
            cardContent.innerHTML = '<span style="color: #999;">æ­£åœ¨ä¿®æ­£...</span>';

            try {
                // æ„å»ºæç¤ºè¯ï¼ˆè‡ªåŠ¨è¿½åŠ å¾…ä¿®æ­£æ–‡æœ¬ï¼‰
                const prompt = aiConfig.aiPromptTemplate + '\n\nå¾…ä¿®æ­£æ–‡æœ¬ï¼š' + originalText;

                // è°ƒç”¨Ollama API
                const response = await fetch(aiConfig.ollamaApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: aiConfig.ollamaModel,
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: 0.0,
                            top_p: 1.0,
                            num_ctx: 2048
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const fixedText = data.response;

                if (!fixedText || fixedText.trim() === '') {
                    throw new Error('AIè¿”å›ç©ºç»“æœ');
                }

                // æ›´æ–°å¡ç‰‡å†…å®¹
                            card.dataset.originalText = fixedText;
                            cardContent.innerHTML = highlightDuplicates(fixedText);
                            copyToClipboard(fixedText);
                        } catch (error) {                console.error('AIä¿®æ­£å¤±è´¥:', error);
                alert(`AIä¿®æ­£å¤±è´¥ï¼š${error.message}\nè¯·æ£€æŸ¥OllamaæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ`);
                // æ¢å¤åŸå§‹å†…å®¹
                cardContent.innerHTML = originalContent;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                aiButton.textContent = 'ğŸ¤–';
                aiButton.disabled = false;
            }
        }

        // è¿›å…¥ç¼–è¾‘æ¨¡å¼
        function enterEditMode(card, originalText) {
            card.classList.add('editing');
            
            // è·å–å¡ç‰‡å†…å®¹å®¹å™¨
            const cardContent = card.querySelector('.card-content');
            const aiButton = card.querySelector('.ai-correct-button');
            
            // åˆ›å»ºtextarea
            const textarea = document.createElement('textarea');
            textarea.value = originalText;
            textarea.style.width = '100%';
            textarea.style.resize = 'none'; // ç¦æ­¢æ‰‹åŠ¨è°ƒæ•´
            textarea.style.fontSize = '14px';
            textarea.style.lineHeight = '1.6';
            textarea.style.border = 'none';
            textarea.style.outline = 'none';
            textarea.style.backgroundColor = 'transparent';
            textarea.style.overflow = 'hidden'; // éšè—æ»šåŠ¨æ¡
            
            // æ¸…ç©ºå¡ç‰‡å†…å®¹å®¹å™¨ï¼Œä¿ç•™AIæŒ‰é’®
            cardContent.innerHTML = '';
            cardContent.appendChild(textarea);
            textarea.focus();

            // è‡ªé€‚åº”é«˜åº¦å‡½æ•°
            const autoResize = () => {
                textarea.style.height = 'auto'; // é‡ç½®é«˜åº¦
                textarea.style.height = textarea.scrollHeight + 'px'; // è®¾ç½®ä¸ºå†…å®¹é«˜åº¦
            };

            // åˆå§‹åŒ–æ—¶è°ƒæ•´é«˜åº¦
            autoResize();

            // è¾“å…¥æ—¶è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            textarea.addEventListener('input', autoResize);

            const confirmEdit = () => {
                const newText = textarea.value.trim();
                if (newText && newText !== originalText) {
                    // æ›´æ–°å¡ç‰‡å†…å®¹ï¼ˆå¸¦é«˜äº®ï¼‰
                    cardContent.innerHTML = highlightDuplicates(newText);
                    // æ›´æ–° data-original-text å±æ€§
                    card.dataset.originalText = newText;
                    copyToClipboard(newText);
                } else {
                    // æ¢å¤åŸå§‹å†…å®¹ï¼ˆå¸¦é«˜äº®ï¼‰
                    cardContent.innerHTML = highlightDuplicates(originalText);
                }
                card.classList.remove('editing');
            };

            textarea.onblur = confirmEdit;
            textarea.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    cardContent.innerHTML = highlightDuplicates(originalText);
                    card.classList.remove('editing');
                }
            };
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // éšè—æ˜¾æ§åŒº
        function hideControlPanel() {
            console.log('éšè—æ˜¾æ§åŒº');
            document.getElementById('control-panel').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ˜¾æ§åŒº
        function showControlPanel() {
            console.log('æ˜¾ç¤ºæ˜¾æ§åŒº');
            document.getElementById('control-panel').classList.remove('hidden');
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>